<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discord-Style Messenger</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { display: flex; height: 100vh; background-color: #36393f; color: #ffffff; overflow: hidden; }
.servers-bar { width: 72px; background-color: #202225; display: flex; flex-direction: column; align-items: center; padding-top: 12px; overflow-y: auto; }
.server-icon { width: 48px; height: 48px; border-radius: 50%; background-color: #36393f; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: border-radius 0.2s; font-size: 20px; position: relative; }
.server-icon:hover { border-radius: 16px; background-color: #292b2f; }
.server-icon.active { border-radius: 16px; background-color: #ffffff; color: #36393f; }
.add-server { margin-top: 8px; color: #43b581; }
.notification-badge { position: absolute; top: -4px; right: -4px; background-color: #f04747; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.channels-panel { width: 240px; background-color: #2f3136; display: flex; flex-direction: column; }
.server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid #292b2f; }
.server-name { font-weight: bold; font-size: 16px; }
.channels-list { padding: 8px 8px 0 8px; overflow-y: auto; flex: 1; }
.channel-category { padding: 8px 8px 4px 8px; font-size: 12px; color: #8e9297; text-transform: uppercase; letter-spacing: 0.5px; }
.channel { display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; }
.channel:hover { background-color: #37393f; }
.channel.active { background-color: #37393f; color: #ffffff; }
.channel-icon { margin-right: 6px; font-size: 14px; }
.channel-name { font-size: 15px; }
.voice-channel { color: #7289da; }
.private-channel { color: #faa61a; }
.add-channel { color: #43b581; margin-left: auto; }
.chat-container { flex: 1; display: flex; flex-direction: column; background-color: #36393f; }
.chat-header { height: 48px; background-color: #2f3136; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid #292b2f; justify-content: space-between; }
.chat-title { font-weight: bold; font-size: 16px; }
.chat-actions { display: flex; gap: 16px; }
.chat-action { cursor: pointer; font-size: 18px; color: #b9bbbe; }
.chat-action:hover { color: #ffffff; }
.chat-messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; }
.message { display: flex; margin-bottom: 16px; padding: 8px 0; }
.avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #43b581; margin-right: 16px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
.message-content { flex: 1; }
.message-header { display: flex; align-items: baseline; margin-bottom: 4px; }
.username { font-weight: bold; margin-right: 8px; color: #ffffff; }
.timestamp { color: #72767d; font-size: 0.8em; }
.message-text { color: #dcddde; line-height: 1.4; white-space: pre-wrap; }
.message-actions { display: flex; gap: 8px; margin-top: 4px; }
.message-action { font-size: 14px; color: #72767d; cursor: pointer; }
.message-action:hover { color: #ffffff; }
.chat-input-container { padding: 16px; background-color: #2f3136; position: relative; }
.chat-input { width: 100%; padding: 12px 16px; border-radius: 8px; border: none; background-color: #40444b; color: #ffffff; font-size: 1rem; resize: none; height: 60px; }
.chat-input:focus { outline: none; background-color: #36393f; }
.members-panel { width: 240px; background-color: #2f3136; padding: 16px; overflow-y: auto; }
.member-category { padding: 8px 0; font-size: 12px; color: #8e9297; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 16px; }
.member-category:first-child { margin-top: 0; }
.member { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
.member-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #43b581; margin-right: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; }
.member-name { color: #ffffff; font-size: 14px; }
.status { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
.status.online { background-color: #43b581; }
.status.offline { background-color: #747f8d; }
.status.busy { background-color: #f04747; }
.status.idle { background-color: #faa61a; }
.call-button { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 10px; display: none; flex-direction: column; align-items: center; z-index: 1000; }
.call-button.active { display: flex; }
.call-controls { display: flex; gap: 20px; margin-top: 20px; }
.call-control { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; }
.call-control.decline { background-color: #f04747; }
.call-control.accept { background-color: #43b581; }
.call-control.mute { background-color: #40444b; }
.call-control.video { background-color: #40444b; }
.profile-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
.profile-modal.active { display: flex; }
.profile-card { background-color: #2f3136; padding: 20px; border-radius: 10px; width: 300px; }
.profile-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: #43b581; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; }
.profile-username { text-align: center; font-size: 18px; margin-bottom: 10px; }
.profile-status { text-align: center; color: #72767d; margin-bottom: 20px; }
.profile-actions { display: flex; gap: 10px; }
.profile-action { flex: 1; padding: 10px; border-radius: 5px; text-align: center; cursor: pointer; }
.profile-action.message { background-color: #40444b; }
.profile-action.call { background-color: #43b581; }
.profile-action.video { background-color: #7289da; }
.emoji-picker { position: absolute; bottom: 80px; right: 20px; background-color: #2f3136; border-radius: 10px; padding: 10px; display: none; grid-template-columns: repeat(8, 1fr); gap: 5px; max-width: 200px; }
.emoji-picker.active { display: grid; }
.emoji { font-size: 20px; cursor: pointer; text-align: center; }
.emoji:hover { transform: scale(1.2); }
.attachment-button { position: absolute; right: 80px; bottom: 20px; background: none; border: none; color: #b9bbbe; cursor: pointer; font-size: 18px; }
.attachment-button:hover { color: #ffffff; }
.user-menu { position: absolute; bottom: 20px; left: 20px; display: flex; align-items: center; cursor: pointer; }
.user-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #43b581; margin-right: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.user-info { display: flex; flex-direction: column; }
.user-name { font-weight: bold; font-size: 14px; }
.user-status { font-size: 12px; color: #b9bbbe; }
.user-menu-dropdown { position: absolute; bottom: 50px; left: 0; background-color: #18191c; border-radius: 5px; padding: 10px 0; min-width: 200px; display: none; }
.user-menu-dropdown.active { display: block; }
.user-menu-item { padding: 8px 16px; cursor: pointer; }
.user-menu-item:hover { background-color: #2f3136; }
.search-bar { padding: 8px; background-color: #202225; border-radius: 4px; margin-bottom: 16px; }
.search-input { width: 100%; padding: 6px 12px; border-radius: 4px; border: none; background-color: #2f3136; color: #ffffff; }
.search-input:focus { outline: none; }
.channel-header { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #292b2f; }
.channel-info { flex: 1; }
.channel-description { font-size: 12px; color: #72767d; }
.notification-icon { color: #f04747; margin-left: 8px; }
.voice-status { display: flex; align-items: center; padding: 8px; background-color: #37393f; border-radius: 4px; margin-top: 8px; }
.voice-icon { color: #7289da; margin-right: 8px; }
.voice-channel-name { font-size: 14px; }
.voice-controls { margin-top: 8px; display: flex; gap: 8px; }
.voice-control { flex: 1; padding: 6px; border-radius: 4px; background-color: #40444b; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.voice-control:hover { background-color: #37393f; }
.voice-control.muted { color: #f04747; }
.voice-control.deafened { color: #f04747; }
.private-message { background-color: rgba(88, 101, 242, 0.1); border-left: 2px solid #5865f2; }
.toolbar { display: flex; align-items: center; gap: 8px; padding: 8px; background-color: #2f3136; border-top: 1px solid #292b2f; }
.user-select { margin-left: auto; background-color: #40444b; color: #fff; border: none; border-radius: 6px; padding: 6px 8px; }
  </style>
</head>
<body>
  <div class="servers-bar" id="servers"></div>
  <div class="channels-panel">
    <div class="server-header"><div class="server-name" id="server-name">General Server</div></div>
    <div class="search-bar"><input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤..." id="channel-search"></div>
    <div class="channels-list" id="channels"></div>
    <div class="voice-status"><i class="fas fa-microphone voice-icon"></i><span class="voice-channel-name" id="voice-status">–í #General</span></div>
    <div class="voice-controls">
      <div class="voice-control" title="–ü—Ä–∏–≥–ª—É—à–∏—Ç—å"><i class="fas fa-microphone"></i></div>
      <div class="voice-control" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫"><i class="fas fa-volume-up"></i></div>
      <div class="voice-control" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i class="fas fa-cog"></i></div>
    </div>
  </div>
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-title" id="chat-title">#general</div>
      <div class="chat-actions">
        <i class="fas fa-search chat-action"></i>
        <i class="fas fa-paperclip chat-action"></i>
        <i class="fas fa-ellipsis-h chat-action"></i>
      </div>
    </div>
    <div class="channel-header">
      <div class="channel-info">
        <div class="channel-title" id="channel-title">#general</div>
        <div class="channel-description" id="channel-description">–û–±—â–∏–π –∫–∞–Ω–∞–ª –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
      </div>
      <i class="fas fa-bell notification-icon"></i>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-container">
      <button class="attachment-button"><i class="fas fa-plus"></i></button>
      <textarea class="chat-input" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ #general"></textarea>
      <div class="emoji-picker" id="emoji-picker">
        <div class="emoji">üòÄ</div><div class="emoji">üòÇ</div><div class="emoji">üòç</div><div class="emoji">ü•∞</div>
        <div class="emoji">üòé</div><div class="emoji">ü§©</div><div class="emoji">ü•≥</div><div class="emoji">üò≠</div>
        <div class="emoji">üò°</div><div class="emoji">ü§Ø</div><div class="emoji">ü•∂</div><div class="emoji">ü§†</div>
        <div class="emoji">üëª</div><div class="emoji">üí©</div><div class="emoji">üëç</div><div class="emoji">üëè</div>
      </div>
    </div>
    <div class="toolbar">
      <span>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
      <select id="user-select" class="user-select"></select>
    </div>
  </div>
  <div class="members-panel" id="members"></div>

  <div class="call-button" id="call-notification">
    <div class="call-user" id="call-user">User1 –∑–≤–æ–Ω–∏—Ç –≤–∞–º</div>
    <div class="call-controls">
      <div class="call-control decline" id="decline-call"><i class="fas fa-phone"></i></div>
      <div class="call-control accept" id="accept-call"><i class="fas fa-phone"></i></div>
    </div>
  </div>

  <div class="profile-modal" id="profile-modal">
    <div class="profile-card">
      <div class="profile-avatar" id="profile-avatar">U</div>
      <div class="profile-username" id="profile-username">User</div>
      <div class="profile-status" id="profile-status">–æ–Ω–ª–∞–π–Ω</div>
      <div class="profile-actions">
        <div class="profile-action message">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
        <div class="profile-action call">–ó–≤–æ–Ω–æ–∫</div>
        <div class="profile-action video">–í–∏–¥–µ–æ</div>
      </div>
    </div>
  </div>

  <div class="user-menu">
    <div class="user-avatar" id="me-avatar">ME</div>
    <div class="user-info">
      <div class="user-name" id="me-name">MyUser</div>
      <div class="user-status" id="me-tag">#4321</div>
    </div>
    <div class="user-menu-dropdown" id="user-menu-dropdown">
      <div class="user-menu-item">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="user-menu-item">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="user-menu-item">–í—ã—Ö–æ–¥</div>
    </div>
  </div>

  <script>
function ensureSocketIo() {
  return new Promise((resolve, reject) => {
    if (window.io) return resolve();
    const script = document.createElement('script');
    script.src = 'https://cdn.socket.io/4.8.1/socket.io.min.js';
    script.crossOrigin = 'anonymous';
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('Failed to load Socket.IO client'));
    document.head.appendChild(script);
  });
}

document.addEventListener('DOMContentLoaded', async () => {
  const servedByNode = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') && location.port === '3000';
  const apiMeta = document.querySelector('meta[name="api-base"]');
  const configuredApiBase = apiMeta && apiMeta.content ? apiMeta.content.trim() : '';
  const apiBase = configuredApiBase || (servedByNode ? '' : 'http://localhost:3000');
  await ensureSocketIo();
  const socket = servedByNode && !configuredApiBase ? io() : io(apiBase, { transports: ['websocket', 'polling'] });
  const serversEl = document.getElementById('servers');
  const channelsEl = document.getElementById('channels');
  const serverNameEl = document.getElementById('server-name');
  const chatTitleEl = document.getElementById('chat-title');
  const channelTitleEl = document.getElementById('channel-title');
  const channelDescEl = document.getElementById('channel-description');
  const chatMessagesEl = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const emojiPicker = document.getElementById('emoji-picker');
  const membersEl = document.getElementById('members');
  const userSelect = document.getElementById('user-select');
  const userMenu = document.querySelector('.user-menu');
  const userMenuDropdown = document.getElementById('user-menu-dropdown');
  const profileModal = document.getElementById('profile-modal');
  const profileAvatar = document.getElementById('profile-avatar');
  const profileUsername = document.getElementById('profile-username');
  const profileStatus = document.getElementById('profile-status');
  const meAvatar = document.getElementById('me-avatar');
  const meName = document.getElementById('me-name');
  const meTag = document.getElementById('me-tag');
  const callNotification = document.getElementById('call-notification');
  const acceptCall = document.getElementById('accept-call');
  const declineCall = document.getElementById('decline-call');

  let state = {
    servers: [],
    channels: [],
    users: [],
    currentServerId: null,
    currentChannel: null,
    currentUserId: null
  };

  function setCurrentUser(id) {
    state.currentUserId = id;
    const u = state.users.find(x => String(x.id) === String(id));
    if (u) {
      meAvatar.textContent = (u.username[0] || 'U').toUpperCase();
      meName.textContent = u.username;
      meTag.textContent = u.tag;
    }
    localStorage.setItem('currentUserId', id);
  }

  async function loadServers() {
    const res = await fetch(apiBase + '/api/servers').catch(() => null);
    if (!res || !res.ok) {
      serversEl.innerHTML = '';
      const warn = document.createElement('div');
      warn.style.padding = '12px';
      warn.style.fontSize = '12px';
      warn.style.color = '#faa61a';
      warn.textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω http://localhost:3000';
      serversEl.appendChild(warn);
      return;
    }
    state.servers = await res.json();
    serversEl.innerHTML = '';
    state.servers.forEach((s, idx) => {
      const btn = document.createElement('div');
      btn.className = 'server-icon' + (idx === 0 ? ' active' : '');
      btn.dataset.server = s.id;
      btn.innerHTML = '<i class="fab fa-discord"></i>';
      btn.addEventListener('click', () => selectServer(s.id, btn));
      serversEl.appendChild(btn);
    });
    const addBtn = document.createElement('div');
    addBtn.className = 'server-icon add-server';
    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
    serversEl.appendChild(addBtn);
    if (state.servers[0]) selectServer(state.servers[0].id, serversEl.querySelector('.server-icon'));
  }

  async function selectServer(serverId, btnEl) {
    serversEl.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    state.currentServerId = serverId;
    const server = state.servers.find(s => s.id === serverId);
    serverNameEl.textContent = server ? server.name : 'Server';
    await loadChannels(serverId);
  }

  async function loadChannels(serverId) {
    const res = await fetch(apiBase + '/api/servers/' + serverId + '/channels').catch(() => null);
    if (!res || !res.ok) {
      channelsEl.innerHTML = '';
      return;
    }
    state.channels = await res.json();
    renderChannels();
    const firstText = state.channels.find(c => c.type === 'text') || state.channels[0];
    if (firstText) selectChannel(firstText.id);
  }

  function renderChannels(filterText = '') {
    channelsEl.innerHTML = '';
    const categories = [
      { title: '–¢–µ–∫—Å—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã', type: 'text' },
      { title: '–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã', type: 'private' },
      { title: '–ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã', type: 'voice' }
    ];
    categories.forEach(cat => {
      const catEl = document.createElement('div');
      catEl.className = 'channel-category';
      catEl.textContent = cat.title;
      channelsEl.appendChild(catEl);
      state.channels
        .filter(c => c.type === cat.type)
        .filter(c => c.name.toLowerCase().includes(filterText.toLowerCase()))
        .forEach(c => {
          const ch = document.createElement('div');
          ch.className = 'channel' + (c.type === 'voice' ? ' voice-channel' : c.type === 'private' ? ' private-channel' : '');
          ch.dataset.channel = c.id;
          const icon = c.type === 'voice' ? 'microphone' : c.type === 'private' ? 'lock' : 'hashtag';
          ch.innerHTML = '<i class="fas fa-' + icon + ' channel-icon"></i><span class="channel-name">' + c.name + '</span>';
          ch.addEventListener('click', () => selectChannel(c.id));
          channelsEl.appendChild(ch);
        });
    });
  }

  async function loadUsers() {
    const res = await fetch(apiBase + '/api/users').catch(() => null);
    if (!res || !res.ok) {
      membersEl.innerHTML = '';
      return;
    }
    state.users = await res.json();
    renderMembers();
    renderUserSelect();
    const savedId = localStorage.getItem('currentUserId');
    const defaultId = savedId && state.users.some(u => String(u.id) === String(savedId)) ? savedId : state.users[0]?.id;
    if (defaultId) {
      setCurrentUser(defaultId);
      userSelect.value = String(defaultId);
    }
  }

  function renderMembers() {
    membersEl.innerHTML = '';
    const online = state.users.filter(u => u.status !== 'offline');
    const offline = state.users.filter(u => u.status === 'offline');
    const makeCategory = (title, count) => {
      const el = document.createElement('div');
      el.className = 'member-category';
      el.textContent = title + ' ‚Äî ' + count;
      return el;
    };
    membersEl.appendChild(makeCategory('–û–ù–õ–ê–ô–ù', online.length));
    online.forEach(u => membersEl.appendChild(makeMember(u)));
    membersEl.appendChild(makeCategory('–û–§–õ–ê–ô–ù', offline.length));
    offline.forEach(u => membersEl.appendChild(makeMember(u)));
  }

  function makeMember(u) {
    const el = document.createElement('div');
    el.className = 'member';
    el.dataset.user = u.id;
    const colorClass = u.status === 'online' ? 'online' : u.status === 'busy' ? 'busy' : u.status === 'idle' ? 'idle' : 'offline';
    el.innerHTML = '<div class="status ' + colorClass + '"></div><div class="member-avatar">' + (u.username[0] || 'U') + '</div><div class="member-name">' + u.username + '</div>';
    el.addEventListener('click', () => openProfile(u));
    return el;
  }

  function renderUserSelect() {
    userSelect.innerHTML = '';
    state.users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.username + ' ' + u.tag;
      userSelect.appendChild(opt);
    });
  }

  function openProfile(u) {
    profileAvatar.textContent = (u.username[0] || 'U').toUpperCase();
    profileUsername.textContent = u.username;
    profileStatus.textContent = u.status;
    profileModal.style.display = 'flex';
  }

  async function selectChannel(channelId) {
    state.currentChannel = state.channels.find(c => c.id === channelId);
    if (!state.currentChannel) return;
    document.querySelectorAll('.channel').forEach(ch => ch.classList.remove('active'));
    const activeEl = [...document.querySelectorAll('.channel')].find(el => Number(el.dataset.channel) === Number(channelId));
    if (activeEl) activeEl.classList.add('active');

    chatTitleEl.textContent = '#' + state.currentChannel.name;
    channelTitleEl.textContent = '#' + state.currentChannel.name;
    channelDescEl.textContent = state.currentChannel.description || '';
    messageInput.placeholder = '–°–æ–æ–±—â–µ–Ω–∏–µ #' + state.currentChannel.name;
    await loadMessages(channelId);
    socket.emit('channel:join', { channelId });
  }

  async function loadMessages(channelId) {
    const res = await fetch(apiBase + '/api/channels/' + channelId + '/messages');
    const msgs = await res.json();
    chatMessagesEl.innerHTML = '';
    msgs.forEach(renderMessage);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  function renderMessage(m) {
    const row = document.createElement('div');
    row.className = 'message';
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = (m.user.username[0] || 'U').toUpperCase();
    const content = document.createElement('div');
    content.className = 'message-content';
    const header = document.createElement('div');
    header.className = 'message-header';
    const uname = document.createElement('div');
    uname.className = 'username';
    uname.textContent = m.user.username;
    const timestamp = document.createElement('div');
    timestamp.className = 'timestamp';
    const dt = new Date(m.createdAt);
    const hm = dt.toTimeString().slice(0,5);
    timestamp.textContent = '–°–µ–≥–æ–¥–Ω—è –≤ ' + hm;
    const text = document.createElement('div');
    text.className = 'message-text';
    text.textContent = m.content;
    const actions = document.createElement('div');
    actions.className = 'message-actions';
    actions.innerHTML = '<i class="far fa-comment message-action"></i><i class="far fa-thumbs-up message-action"></i><i class="far fa-bookmark message-action"></i><i class="fas fa-ellipsis-h message-action"></i>';
    header.appendChild(uname); header.appendChild(timestamp);
    content.appendChild(header); content.appendChild(text); content.appendChild(actions);
    row.appendChild(avatar); row.appendChild(content);
    chatMessagesEl.appendChild(row);
  }

  async function sendMessage() {
    if (!state.currentChannel || !state.currentUserId) return;
    const content = messageInput.value.trim();
    if (!content) return;
    const res = await fetch(apiBase + '/api/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        channelId: state.currentChannel.id,
        userId: state.currentUserId,
        content
      })
    });
    if (res.ok) {
      messageInput.value = '';
    }
  }

  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  socket.on('message:new', (msg) => {
    if (!state.currentChannel || Number(msg.channelId) !== Number(state.currentChannel.id)) return;
    renderMessage(msg);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });

  // Emoji picker
  messageInput.addEventListener('focus', () => {
    emojiPicker.style.display = 'grid';
  });
  document.querySelectorAll('.emoji').forEach(emoji => {
    emoji.addEventListener('click', () => {
      messageInput.value += emoji.textContent;
      messageInput.focus();
    });
  });

  // User menu
  userMenu.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenuDropdown.classList.toggle('active');
  });
  document.addEventListener('click', (e) => {
    if (!userMenu.contains(e.target)) {
      userMenuDropdown.classList.remove('active');
    }
  });

  // Profile open/close
  window.addEventListener('click', (e) => {
    if (e.target === profileModal) profileModal.style.display = 'none';
  });

  // Members click to open profile is set in makeMember

  // Incoming call simulation
  setTimeout(() => { callNotification.style.display = 'flex'; }, 5000);
  acceptCall.addEventListener('click', () => { callNotification.style.display = 'none'; alert('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç!'); });
  declineCall.addEventListener('click', () => { callNotification.style.display = 'none'; alert('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω!'); });

  // Channel search
  document.getElementById('channel-search').addEventListener('input', (e) => {
    renderChannels(e.target.value);
  });

  // User selector
  userSelect.addEventListener('change', (e) => {
    setCurrentUser(e.target.value);
  });

  // Init
  Promise.all([loadServers(), loadUsers()]);
});
  </script>
</body>
</html>


